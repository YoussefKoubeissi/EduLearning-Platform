<!DOCTYPE html>
<html lang="en"
      dir="ltr">

    <head>
        <meta charset="utf-8">
        <meta http-equiv="X-UA-Compatible"
              content="IE=edge">
        <meta name="viewport"
              content="width=device-width, initial-scale=1, shrink-to-fit=no">
        <title>Course Preview</title>

        <!-- Prevent the demo from appearing in search engines -->
        <meta name="robots"
              content="noindex">

        <link href="https://fonts.googleapis.com/css?family=Lato:400,700%7CRoboto:400,500%7CExo+2:600&display=swap"
              rel="stylesheet">

        <!-- Preloader -->
        <link type="text/css"
              href="../../public/vendor/spinkit.css"
              rel="stylesheet">

        <!-- Perfect Scrollbar -->
        <link type="text/css"
              href="../../public/vendor/perfect-scrollbar.css"
              rel="stylesheet">

        <!-- Material Design Icons -->
        <link type="text/css"
              href="../../public/css/material-icons.css"
              rel="stylesheet">

        <!-- Font Awesome Icons -->
        <link type="text/css"
              href="../../public/css/fontawesome.css"
              rel="stylesheet">

        <!-- Preloader -->
        <link type="text/css"
              href="../../public/css/preloader.css"
              rel="stylesheet">

        <!-- App CSS -->
        <link type="text/css"
              href="../../public/css/app.css"
              rel="stylesheet">

    </head>

    <body class="layout">

        <div class="preloader">
            <div class="sk-chase">
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
                <div class="sk-chase-dot"></div>
            </div>

            <!-- <div class="sk-bounce">
                <div class="sk-bounce-dot"></div>
                <div class="sk-bounce-dot"></div>
            </div> -->

            <!-- More spinner examples at https://github.com/tobiasahlin/SpinKit/blob/master/examples.html -->
        </div>

        <!-- Drawer Layout -->

        <div class="mdk-drawer-layout js-mdk-drawer-layout" data-push 
            data-responsive-width="992px">
            
            <div class="mdk-drawer-layout__content page-content">

                <!-- Header -->
                <div id="HeaderDiv"></div>
                <!-- // END Header -->

                <!-- BEFORE Page Content -->

                <!-- // END BEFORE Page Content -->

                <!-- Page Content -->

                <!-- jQuery -->
                <script src="../../public/vendor/jquery.min.js"></script>

                <div class="mdk-box bg-primary js-mdk-box mb-0" data-effects="blend-background">
                    <div class="mdk-box__content">
                        <div class="hero py-64pt text-center text-sm-left">
                            <div class="container-fluid page__container">
                                <h1 class="text-white" id="CourseName"></h1>

                                <p class="lead text-white-50 measure-hero-lead" id="CourseDescription"></p>

                                <div class="d-flex flex-column flex-sm-row align-items-center justify-content-start">
                                    <a href="#" id="TakeCourseLink" class="btn btn-outline-white mb-16pt mb-sm-0 mr-sm-16pt">
                                        Watch Course <i class="material-icons icon--right">play_circle_outline</i>
                                    </a>
                                    <a href="pricing.html" class="btn btn-white">Start your free trial</a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="navbar navbar-expand-sm navbar-light bg-white border-bottom-2 navbar-list p-0 m-0 align-items-center">
                    <div class="container-fluid page__container">
                        <ul class="nav navbar-nav flex align-items-sm-center">
                            <li class="nav-item navbar-list__item">
                                <div class="media align-items-center">
                                    <span class="media-left mr-16pt">
                                        <img src="" id="TrainerProfilePic"
                                             width="40"
                                             alt="avatar"
                                             class="rounded-circle">
                                    </span>
                                    <div class="media-body">
                                        <a class="card-title m-0" href="" id="TrainerName"></a>
                                        <p class="text-50 lh-1 mb-0">Instructor</p>
                                    </div>
                                </div>
                            </li>
                            <li class="nav-item navbar-list__item">
                                <i class="material-icons text-muted icon--left">schedule</i>
                                <span id="CourseDuration"></span>
                            </li>
                            <li class="nav-item navbar-list__item">
                                <i class="material-icons text-muted icon--left">assessment</i>
                                Beginner
                            </li>
                            <li class="nav-item ml-sm-auto text-sm-center flex-column navbar-list__item">
                                <div class="rating rating-24">
                                    <div class="rating__item"><i class="material-icons">star</i></div>
                                    <div class="rating__item"><i class="material-icons">star</i></div>
                                    <div class="rating__item"><i class="material-icons">star</i></div>
                                    <div class="rating__item"><i class="material-icons">star</i></div>
                                    <div class="rating__item"><i class="material-icons">star_border</i></div>
                                </div>
                                <p class="lh-1 mb-0"><small class="text-muted">20 ratings</small></p>
                            </li>
                        </ul>
                    </div>
                </div>

                <div class="page-section border-bottom-2">
                    <div class="container-fluid page__container">

                        <div class="page-separator">
                            <div class="page-separator__text">Table of Contents</div>
                        </div>
                        <div class="row mb-0">
                            <div class="col-lg-7">

                                <div class="accordion js-accordion accordion--boxed list-group-flush" id="parent">

                                    <!-- <div class="accordion__item open">

                                        <a href="#" class="accordion__toggle" data-toggle="collapse"
                                           data-target="#course-toc-2" data-parent="#parent">

                                            <span class="flex" id="ChapterName"></span>
                                            <span class="accordion__toggle-icon material-icons">keyboard_arrow_down</span>
                                        </a>

                                        <div class="accordion__menu collapse show" id="course-toc-2">

                                            <div class="accordion__menu-link active">
                                                <span class="icon-holder icon-holder--small icon-holder--primary rounded-circle d-inline-flex icon--left">
                                                    <i class="material-icons icon-16pt">play_circle_outline</i>
                                                </span>
                                                <a class="flex" href="student-lesson.html" id="PartName"></a>
                                                <span class="text-muted" id="PartTime"></span>
                                            </div>

                                        </div>

                                    </div> -->

                                </div>

                            </div>
                            <div class="col-lg-5 justify-content-center">

                                <div class="card">
                                    <div class="card-body py-16pt text-center">
                                        <span class="icon-holder icon-holder--outline-secondary rounded-circle d-inline-flex mb-8pt">
                                            <i class="material-icons">timer</i>
                                        </span>
                                        <h4 class="card-title"><strong>Unlock Library</strong></h4>
                                        <p class="card-subtitle text-70 mb-24pt">Get access to all videos in the library</p>
                                        <a href="pricing.html"
                                           class="btn btn-accent mb-8pt">Sign Up - Only $19.00/mo</a>
                                        <p class="mb-0">Have an account? <a href="login.html">Login</a></p>
                                    </div>
                                </div>

                            </div>
                        </div>
                    </div>
                </div>

                <script>

                    $(document).ready(function(){

                        let CourseHead = "CourseHead";
                        let CourseChapters = "CourseChapters";
                        let apiURL = "../../api/";
                        let mins = 0;
                        let secs = 0;
                        let hours = 0;
                        let CourseDuration;

                        // Function to get the value of a query parameter from the URL using jQuery
                        function getQueryParam(name) {
                            const urlParams = new URLSearchParams(window.location.search);
                            return urlParams.get(name);
                        }
                        // Get the TrainerID from the URL
                        let courseID = getQueryParam("CourseID");
                        //console.log(courseID);

                        // Using Cookie
                        // Function to check if the UserID cookie exists
                        // function checkUserIDCookie() {
                        //     let userIDCookie = getCookie('UserID');
                        //     if (userIDCookie) {
                        //         // UserID cookie exists, redirect to the next page

                        //         //console.log(userIDCookie);
                        //         let userID = parseInt(userIDCookie.split(':')[1]);
                        //         //console.log(userID);
                                
                        //         $.ajax({
                        //             url: "../../api/RegisteredCourses.php",
                        //             data: {
                        //                 UserID: userID,
                        //                 CourseID: courseID
                        //             },
                        //             type: "post",
                        //             dataType: "json",
                        //             success: function (response) {
                        //                 //console.log(response);

                        //                 if (response == "True"){
                        //                     window.location.href = "TakeCourse.html?CourseID=" + courseID;
                        //                     //alert("true");
                        //                 }
                        //                 else{
                        //                     alert("You are not registered in this course!");
                        //                 }
                        //             },
                        //             error: function (E) {
                        //                 alert(E.status + E.statusText)
                        //             }
                        //         });

                        //         //window.location.href = "TakeCourse.html?CourseID=" + courseID;
                        //     } else {
                        //         // UserID cookie does not exist, prompt user to log in
                        //         //alert('Please log in to proceed.');

                        //         window.location.href = "LoginPage.html?CourseID=" + courseID;
                        //     }
                        // }

                        // // Function to get the value of a cookie by its name
                        // function getCookie(cookieName) {
                        //     let name = cookieName + '=';
                        //     let decodedCookie = decodeURIComponent(document.cookie);
                        //     let cookieArray = decodedCookie.split(';');
                        //     for(let i = 0; i <cookieArray.length; i++) {
                        //         let cookie = cookieArray[i];
                        //         while (cookie.charAt(0) == ' ') {
                        //             cookie = cookie.substring(1);
                        //         }
                        //         if (cookie.indexOf(name) == 0) {
                        //             return cookie.substring(name.length, cookie.length);
                        //         }
                        //     }
                        //     return null;
                        // }

                        // Attach event listener to the button using jQuery
                        //$("#TakeCourseLink").click(checkUserIDCookie);
                        $("#TakeCourseLink").click(function(e){
                            e.preventDefault()

                            //checkUserIDCookie();

                            // Retrieve data from local storage
                            let jwt = localStorage.getItem('jwt');
                            //console.log(jwt); // Output: value

                            if (jwt != null){

                                $.ajax({
                                    url: "../../api/AuthorizationJWT.php",
                                    headers: {
                                        Authorization: 'Bearer' + jwt
                                    },
                                    type: "post",
                                    dataType: "json",
                                    success: function (response) {
                                        //console.log(response);

                                        let userID = response.UserID;
                                        //console.log(userID);

                                        $.ajax({
                                            url: "../../api/RegisteredCourses.php",
                                            data: {
                                                UserID: userID,
                                                CourseID: courseID
                                            },
                                            type: "post",
                                            dataType: "json",
                                            success: function (response) {
                                                //console.log(response);

                                                if (response == "True"){
                                                    window.location.href = "TakeCourse.html?CourseID=" + courseID;
                                                    //alert("true");
                                                }
                                                else{
                                                    alert("You are not registered in this course!");
                                                }
                                            },
                                            error: function (E) {
                                                alert(E.status + E.statusText)
                                            }
                                        });

                                    },
                                    error: function (E) {
                                        alert(E.status + E.statusText)
                                    }
                                });

                            }
                            else{
                                //
                                window.location.href = "LoginPage.html?CourseID=" + courseID;
                            }

                        });

                        $.ajax({
                            url: "../../api/GetCourseInfo.php",
                            data: {
                                operation: CourseHead,
                                CourseID: courseID

                            },
                            type: "post",
                            dataType: "json",
                            success: function (response) {
                                //console.log(response);
                                // Access and use the returned data here:
                                let course = response[0]; // assuming 'data' contains a single user object
                                    
                                // Extract individual values into variables:
                                let courseID = course.CourseID;
                                //console.log(courseID);

                                let trainername = course.TrainerName;
                                $("#TrainerName").html(trainername);
                                //console.log(trainername);

                                let coursename = course.CourseName;
                                $("#CourseName").html(coursename);
                                //console.log(coursename);

                                let coursedescription = course.CourseDescription;
                                $("#CourseDescription").html(coursedescription);
                                //console.log(coursedescription);

                                let userProfilePic = course.UserProfilePic;
                                userProfilePic = apiURL + userProfilePic;
                                $("#TrainerProfilePic").attr('src', userProfilePic);
                                //console.log(userProfilePic);

                                $.each(response, function (index, course) {

                                    let coursemin = course.VideoMin;
                                    //console.log(coursemin);

                                    mins = coursemin + mins;
                                    //console.log(mins);

                                    let coursesec = course.VideoSec;
                                    //console.log(coursesec);

                                    secs = coursesec + secs;
                                    //console.log(secs);

                                });

                                if (secs >= 60){
                                    while (secs >= 60){
                                        secs = secs - 60;
                                        mins = mins + 1;
                                    }
                                }

                                if (mins >= 60){
                                    while (mins >= 60){
                                        mins = mins - 60;
                                        hours = hours + 1;
                                    }
                                }

                                // console.log(hours);
                                // console.log(mins);
                                // console.log(secs);

                                //console.log(hours + "h " + mins + "m " + secs + "s");

                                if (hours > 0){
                                    CourseDuration = hours + "h " + mins + "m " + secs + "s";
                                    $("#CourseDuration").html(CourseDuration);
                                    //console.log(CourseDuration);
                                }
                                else if (mins > 0){
                                    CourseDuration = mins + "m " + secs + "s";
                                    $("#CourseDuration").html(CourseDuration);
                                    //console.log(CourseDuration);
                                }
                                else {
                                    CourseDuration = secs + "s";
                                    $("#CourseDuration").html(CourseDuration);
                                    //console.log(CourseDuration);
                                }

                                // let userLastName = user.UserLastName;
                                // $("#LastName").val(userLastName);
                                // //console.log(userLastName);

                                // let userName = user.UserName;
                                // $("#Username").val(userName);
                                // //console.log(userName);

                                // let userPassword = user.UserPassword;
                                // $("#Password").val(userPassword);
                                // //console.log(userPassword);

                                // let userEmail = user.UserEmail;
                                // $("#Email").val(userEmail);
                                // //console.log(userEmail);

                                // let userTelephone = user.UserTelephone;
                                // $("#PhoneNumber").val(userTelephone);
                                // //console.log(userTelephone);

                                // let userGender = user.UserGender;
                                // $("input[name='gender']").filter(`[value='${userGender}']`).prop('checked', true);
                                // //console.log(userGender);

                                // let isActive = user.IsActive;
                                // $("#IsActive").prop("checked", isActive);
                                // //console.log(isActive);
                                    
                                // Assuming user is defined and contains DateofBirth and JoinDate properties
                                // if (user && user.DateofBirth && user.DateofBirth.date) {
                                //     let dateOfBirth = new Date(user.DateofBirth.date);
                                //     let formattedDateOfBirth = dateOfBirth.getFullYear() + '-' + ('0' + (dateOfBirth.getMonth() + 1)).slice(-2) + '-' + ('0' + dateOfBirth.getDate()).slice(-2);
                                //     $("#DateofBirth").val(formattedDateOfBirth);
                                // } else {
                                //     console.error("Invalid or missing DateofBirth property in the user object.");
                                // }

                                // if (user && user.JoinDate && user.JoinDate.date) {
                                //     let joinDate = new Date(user.JoinDate.date);
                                //     let formattedJoinDate = joinDate.getFullYear() + '-' + ('0' + (joinDate.getMonth() + 1)).slice(-2) + '-' + ('0' + joinDate.getDate()).slice(-2);
                                //     $("#JoinDate").val(formattedJoinDate);
                                // } else {
                                //     console.error("Invalid or missing JoinDate property in the user object.");
                                // }

                                //let userType = user.UserType;
                                //console.log(userType);
                                    
                                // ... repeat for other properties

                            },
                            error: function (E) {
                                alert(E.status + E.statusText)
                            }
                        });

                        $.ajax({
                            url: "../../api/GetCourseInfo.php",
                            data: {
                                operation: CourseChapters,
                                CourseID: courseID

                            },
                            type: "post",
                            dataType: "json",
                            success: function (response) {
                                //console.log(response);
                                
                                let processedchapters = {};

                                $.each(response, function (index, chapter) {

                                    let chapterID = chapter.ChapterID;

                                    let partname = chapter.PartName;

                                    if (partname != null){
                                        if (!processedchapters[chapterID]){
                                            processedchapters[chapterID] = true;

                                            let chaptername = chapter.ChapterName;

                                            let chapterDiv = `
                                                <div class="accordion__item open">

                                                    <a href="#" class="accordion__toggle" data-toggle="collapse"
                                                    data-target="#course-toc-${chapterID}" data-parent="#parent">

                                                        <span class="flex">${chaptername}</span>
                                                        <span class="accordion__toggle-icon material-icons">keyboard_arrow_down</span>
                                                    </a>

                                                    <div class="accordion__menu collapse show" id="course-toc-${chapterID}">
                                                        <div class="line"></div>

                                                    </div>

                                                </div>`;

                                            $("#parent").append(chapterDiv);
                                        }

                                        let chaptermin = chapter.VideoMin;

                                        let chaptersec = chapter.VideoSec;

                                        let parttime = chaptermin + "m " + chaptersec + "s";

                                        let partDiv = `<div class="accordion__menu-link active">
                                                            <span class="icon-holder icon-holder--small icon-holder--primary rounded-circle d-inline-flex icon--left">
                                                                <i class="material-icons icon-16pt">play_circle_outline</i>
                                                            </span>
                                                            <span class="flex">${partname}</span>
                                                            <span class="text-muted">${parttime}</span>
                                                        </div>`;

                                        $(`#course-toc-${chapterID}`).append(partDiv);

                                    }
                                });

                            },
                            error: function (E) {
                                alert(E.status + E.statusText)
                            }
                        });

                    });
                    
                </script>

                <!-- // END Page Content -->

                <!-- Footer -->
                <div id="FooterDiv"></div>
                <!-- // END Footer -->

            </div>

            <!-- // END drawer-layout__content -->

            <!-- Drawer -->

            <!-- // END Drawer -->

        </div>

        <!-- // END Drawer Layout -->

        

        <!-- Bootstrap -->
        <script src="../../public/vendor/popper.min.js"></script>
        <script src="../../public/vendor/bootstrap.min.js"></script>

        <!-- Perfect Scrollbar -->
        <script src="../../public/vendor/perfect-scrollbar.min.js"></script>

        <!-- DOM Factory -->
        <script src="../../public/vendor/dom-factory.js"></script>

        <!-- MDK -->
        <script src="../../public/vendor/material-design-kit.js"></script>

        <!-- App JS -->
        <script src="../../public/js/app.js"></script>
        <script src="Header.js"></script>
        <script src="Footer.js"></script>

        <!-- Preloader -->
        <script src="../../public/js/preloader.js"></script>

    </body>

</html>